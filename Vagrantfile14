# -*- mode: ruby -*-
# vi: set ft=ruby :

# Windows users must manually set a shell variable for X11 forwarding
if ARGV[0] =~ /^up|provision$/i and not ARGV.include?("--no-provision")  then
  if Vagrant::Util::Platform.windows? then
    STDERR.puts "Windows detected. Remember to set DISPLAY to enable X11 forwarding."
  end
end

# All Vagrant configuration is done below. The "2" in Vagrant.configure
# configures the configuration version (we support older styles for
# backwards compatibility). Please don't change it unless you know what
# you're doing.

Vagrant.configure(2) do |config|

  # 64 bit Ubuntu Vagrant Box
  config.vm.box = "ubuntu/trusty64"
  #config.vm.box = "ubuntu/xenial64"
  #config.vm.box = "ubuntu/bionic64"

  ## Configure hostname and port forwarding
  config.vm.hostname = "cos316"
  config.ssh.forward_x11 = true
  config.vm.network "forwarded_port", guest: 8888, host: 8888
  # Tinode server
  config.vm.network "forwarded_port", guest: 6060, host: 6060
  # Tegola server
  config.vm.network "forwarded_port", guest: 7070, host: 7070

  vagrant_root = File.dirname(__FILE__)

  # Synced Assignment Directories
  # Replace "<path>" with the actual path from the vagrantfile to your cloned
  # assignment directory, and uncomment the line for the appropriate assignment:

  # config.vm.synced_folder "<path to A1 repo>", "/vagrant/assignments/assignment1"
  # config.vm.synced_folder "<path to A2 repo>", "/vagrant/assignments/assignment2"
  # config.vm.synced_folder "<path to A3 repo>", "/vagrant/assignments/assignment3"
  # config.vm.synced_folder "<path to A4 repo>", "/vagrant/assignments/assignment4"
  # config.vm.synced_folder "<path to A5 repo>", "/vagrant/assignments/assignment5"
  # config.vm.synced_folder "<path to A6 repo>", "/vagrant/assignments/assignment6"
  # config.vm.synced_folder "<path to A7 repo>", "/vagrant/assignments/assignment7"



  # Emacs settings
  config.vm.provision "file", source: "#{vagrant_root}/config_files/dot_emacs", destination: "~/.emacs"

  # Jupyter notebook settings
  config.vm.provision "file", source: "#{vagrant_root}/config_files/jupyter_notebook_config.py", destination: "~/.jupyter/jupyter_notebook_config.py"

  # Flottbot config
  config.vm.provision "file", source: "#{vagrant_root}/config_files/flottbot/config", destination: "~/flottbot/config"

  # Tegola config
  config.vm.provision "file", source: "#{vagrant_root}/config_files/tegola", destination: "~/tegola"
  config.vm.provision "file", source: "#{vagrant_root}/config_files/mysql.exp", destination: "~/mysql.exp"

  ## Provisioning
  config.vm.provision "shell", inline: <<-SHELL
    # Ask politely for apt-get not to expect any user input
    export DEBIAN_FRONTEND=noninteractive

    # Ask less politely.
    debconf="/etc/apt/apt.conf.d/70debconf"
    sudo sed -i.bak "s|^DPkg::Pre-Install|//&|" $debconf # comment old preconfigure
    echo 'DPkg::Pre-Install-Pkgs {"/usr/sbin/dpkg-preconfigure --frontend=noninteractive --terse --apt || true";};' >> $debconf

    # install programs needed for setup + testing
    sudo apt-get install -y toilet
    sudo apt-get install -y jq
    disp() { toilet -f mono9 $1; }
    disp "Welcome to COS316"

    # disp "APT Updates"

    # Add MySQL repository to APT
    # TODO: Remove references to wrong sql repo.
    # MYSQL_REPO=http://repo.mysql.com/apt/ubuntu/
    # MYSQL_SOURCES=/etc/apt/sources.list.d/mysql.list
    # touch "${MYSQL_SOURCES}"
    # if grep -q "${MYSQL_REPO}" "${MYSQL_SOURCES}"; then
    #   echo "MySQL repo already up to date. Skipping..."
    # else
    #   echo "Adding MySQL repo..."
    #   sudo apt-key add /vagrant/config_files/mysql-key 2> /dev/null
    #   echo "deb ${MYSQL_REPO} trusty mysql-5.7" >> "${MYSQL_SOURCES}"
    # fi

    # Add PostgreSQL repo to APT
    POSTGRES_REPO=http://apt.postgresql.org/pub/repos/apt
    POSTGRES_SOURCES=/etc/apt/sources.list
    if grep -q "${POSTGRES_REPO}" "${POSTGRES_SOURCES}"; then
      echo "PostgreSQL repo already up to date. Skipping..."
    else
      echo "Adding PostgreSQL repo..."
      echo "deb ${POSTGRES_REPO} trusty-pgdg main" >> ${POSTGRES_SOURCES}
      wget --quiet -O - http://apt.postgresql.org/pub/repos/apt/ACCC4CF8.asc | sudo apt-key add - 2> /dev/null
    fi

    # COS 316 Assignments
    # Assignment 1
    sudo add-apt-repository ppa:gophers/archive 2> /dev/null # For Go 1.11
    sudo apt-get update
    sudo apt-get -y upgrade
    # disp "Emacs"
    # sudo apt-get install -y emacs24-nox
    #
    #
    # # echo "export PYTHONPATH=${PYTHONPATH}:/vagrant/course-bin" >> /home/vagrant/.profile
    #
    # # Set correct permissions for bash scripts
    # scripts="$(find /vagrant -name "*.sh")"
    # if [ -n "$scripts" ]; then
    #   echo "$scripts" | xargs chmod -v 744
    # fi
    #
    # # If the repository was pulled from Windows, convert line breaks to Unix-style
    # sudo apt-get install -y dos2unix
    # printf "Using dos2unix to convert files to Unix format if necessary..."
    # find /vagrant -name "*" -type f | xargs dos2unix -q
    #
    # # Install Go 1.11, the most recent for Ubuntu 14.04
    # disp "Go v1.11"
    # sudo apt-get install -y golang-1.11-go
    # echo "export PATH=${PATH}:/usr/lib/go-1.11/bin:/go/bin" >> /home/vagrant/.profile
    # echo "export GOPATH='/go'" >> /home/vagrant/.profile
    # # echo "export GO111MODULE=auto" >> /home/vagrant/.profile
    # source /home/vagrant/.profile # Make sure go environment variables are set

    # Install MySQL (for Tinode), skipping interactive configuration when possible
    # Note: The default password is obviously not secure. In a real application
    # we would want to change it, but for our purposes this is "good enough"
    disp "MySQL 5.7"
    MYSQL_PWD="cos316"
    sudo debconf-set-selections <<< "mysql-server mysql-server/root_password password ${MYSQL_PWD}"
    sudo debconf-set-selections <<< "mysql-server mysql-server/root_password_again password ${MYSQL_PWD}"
    sudo debconf-set-selections <<< "mysql-community-server mysql-community-server/root-pass password ${MYSQL_PWD}"
    sudo debconf-set-selections <<< "mysql-community-server mysql-community-server/re-root-pass password ${MYSQL_PWD}"

    # Someone decided to make it as hard as possible to install MySQL noninteractively.
    package=mysql-apt-config_0.8.13-1_all.deb
    cd /home/vagrant
    wget -q http://dev.mysql.com/get/$package
    pwd

    # Request noninteractive setup
    # sudo dpkg-reconfigure debconf -f noninteractive -p critical
    # export DEBIAN_FRONTEND=noninteractive

    # Request for noninteractive setup is ignored, so we must set all config options manually
    # or else it will try to launch an interactive installer.
    # sudo debconf-set-selections <<< "mysql-apt-config mysql-apt-config/dmr-warning note"
    # sudo debconf-set-selections <<< "mysql-apt-config mysql-apt-config/preview-component string"
    # sudo debconf-set-selections <<< "mysql-apt-config mysql-apt-config/tools-component string mysql-tools"

    sudo debconf-set-selections <<< "mysql-apt-config mysql-apt-config/repo-codename select trusty"
    sudo debconf-set-selections <<< "mysql-apt-config mysql-apt-config/repo-distro select ubuntu"
    sudo debconf-set-selections <<< "mysql-apt-config mysql-apt-config/repo-url string http://repo.mysql.com/apt"
    sudo debconf-set-selections <<< "mysql-apt-config mysql-apt-config/select-preview select "
    sudo debconf-set-selections <<< "mysql-apt-config mysql-apt-config/select-product select Ok"
    sudo debconf-set-selections <<< "mysql-apt-config mysql-apt-config/select-server select mysql-5.7"
    sudo debconf-set-selections <<< "mysql-apt-config mysql-apt-config/select-tools select "
    sudo debconf-set-selections <<< "mysql-apt-config mysql-apt-config/unsupported-platform select abort"

    # Set up an expect script to run the interactive installer.
    # https://serverfault.com/questions/752063/how-can-i-install-mysql-5-7-9-to-ubuntu-14-04
    sudo apt-get install -y expect
    chmod +x ./mysql.exp
    echo "\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nStarting expect script\n\n\n"
    # wait 5
    # ./mysql.exp
    sudo dpkg -i $package
    echo "\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n Done expect script\n\n\n"

    # sudo dpkg -i $package
    sudo apt-get update
    sudo apt-get install -y mysql-server # This should be the 5.7 version!!
    sudo apt-get install -y mysql-server-5.7

    # sudo apt-get -y install mysql-server

    # This is not the right way to install MySQL, but all the other ways are terrible
    #mysql_package=libmysqlclient-dev_5.7.26-1ubuntu14.04_amd64.deb
    #mysql_package=http://repo.mysql.com/apt/ubuntu/pool/mysql-5.7/m/mysql-community/${mysql_package}
    #wget -q $mysql_package
    # sudo dpkg -i $mysql_package # real one




    # Download and install Tinode chat server
    disp "Tinode"
    sudo apt-get install -y git
    printf "Downloading tinode server... This may take some time."
    go get -tags mysql github.com/tinode/chat/server && go install -tags mysql github.com/tinode/chat/server && echo "tinode server installed"
    go get -tags mysql github.com/tinode/chat/tinode-db && go install -tags mysql github.com/tinode/chat/tinode-db && echo "tinode-db installed"
    printf "Download complete." # "Go installed the following packages:"
    # go list ... | grep tinode

    # Update tinode SQL password
    TINODE_PATH=/go/src/github.com/tinode/chat
    TINODE_STATIC=/home/vagrant/tinode/example-react-js
    echo "export TINODE_PATH=${TINODE_PATH}" >> /home/vagrant/.profile # Debugging convenience
    sudo sed -i.bak "s|root@|root:${MYSQL_PWD}@|" ${TINODE_PATH}/**/tinode.conf

    # Tinode expects these templates to be in /go/bin/templ, rather than /go/src/...
    # TODO Find the root cause of this -- it will likely cause problems later
    if [ ! -d $TINODE_STATIC ]; then
      mkdir /go/bin/templ
      cp $TINODE_PATH/server/templ/* /go/bin/templ
    fi
    printf "Done downloading tinode server"

    # Set up the static web files required by tinode
    sudo apt-get install -y unzip
    tinode-db -config=${TINODE_PATH}/tinode-db/tinode.conf -data=${TINODE_PATH}/tinode-db/data.json
    if [ ! -d $TINODE_STATIC ]; then
      echo "Downloading tinode-chat static files..."
      mkdir -p $TINODE_STATIC && cd $TINODE_STATIC
      sudo wget -q -O webapp-master.zip https://github.com/tinode/webapp/archive/master.zip
      sudo wget -q -O tinode-js-master.zip https://github.com/tinode/tinode-js/archive/master.zip
      echo "Downloaded static tinode files to $(pwd) ..."
      sudo unzip webapp-master.zip
      sudo unzip tinode-js-master.zip tinode-js-master/src/tinode.js
      # Now copy contents of unzipped folder into single dir where they are expected
      sudo cp -r webapp-master/* .
      sudo cp -r tinode-js-master/src/tinode.js .
      # cd elsewhere if desired
    else
      echo "Found existing tinode-chat files. Skipping..."
    fi

    # Install flottbot chatbot
    disp "Flottbot"
    cd /home/vagrant/flottbot
    sudo wget -q -O flottbot.tgz https://github.com/target/flottbot/releases/download/0.2.0/flottbot-linux-amd64.tgz
    tar xzf flottbot.tgz
    echo "Flottbot installed successfully."

    # Install PostgreSQL and PostGIS
    disp "PostgreSQL"
    sudo apt-get install -y postgresql-10
    sudo apt-get install -y postgresql-10-postgis-2.4
    sudo apt-get install -y postgresql-10-postgis-2.4-scripts

    # Install Tegola
    TEGOLA_PATH=/home/vagrant/tegola
    if [ ! -f $TEGOLA_PATH/tegola ]; then

      cd $TEGOLA_PATH
      wget -q -O tegola.zip https://github.com/go-spatial/tegola/releases/download/v0.9.0/tegola_linux_amd64.zip
      unzip tegola.zip

      # Create postgresql user named "user" (?)

      # Set up sample PostGIS Bonn data
      # sudo -u postgres psql -c "CREATE USER user;"
      sudo -u postgres createdb bonn
      wget -q -O bonn_osm.sql.tar.gz https://github.com/go-spatial/tegola-example-data/raw/master/bonn_osm.sql.tar.gz
      tar xzf bonn_osm.sql.tar.gz
      sudo -u postgres psql bonn < bonn_osm.dump > /dev/null 2> /dev/null

      # Set up tegola's db access
      # permissions stills setup wrong, prolly need sudo -u
      sudo -u postgres psql -c "CREATE USER tegola;"
      sudo -u postgres psql -c "ALTER USER tegola with password 'cos316';"
      sudo -u postgres psql -d bonn -c "GRANT SELECT ON ALL TABLES IN SCHEMA public TO tegola;"

      # Add login credentials for
      # echo "local all tegola md5" >> /etc/postgresql/10/main/pg_hba.conf
      sudo sed -i.bak '
        /# DO NOT DISABLE/ i\
        local   all             tegola                                 md5
      ' /etc/postgresql/10/main/pg_hba.conf
      sudo service postgresql restart
    else
      echo "Found existing tegola data. Skipping..."
    fi

    # COS 461 Assignments
    # Assignment 1
    #sudo apt-get install -y python-dev
    #curl -sS https://bootstrap.pypa.io/get-pip.py > get-pip.py
    #sudo python get-pip.py
    #rm -f get-pip.py
    # Install old version of tornado before installing jupyter
    #sudo pip install tornado==4.5.3
    #sudo pip install jupyter
    #sudo pip install -U tzupdate

    # Assignment 2
    #sudo apt-get install -y python-tk

    # Assignment 3
    #sudo pip install nbconvert
    #sudo apt-get install -y mininet
    #sudo apt-get install -y python-numpy
    #sudo apt-get install -y python-matplotlib

    # Assignment 4
    #sudo apt-get install -y whois
    #sudo pip install ipaddress

    # Assignment 6
    #sudo pip install scapy
    #sudo apt-get install -y python-scipy
    #sudo apt-get install -y bind9
    #sudo cp /vagrant/assignment6/bind/* /etc/bind

    # Assignment 7
    # sudo apt-get install -y apache2-utils
    # echo "export GOPATH=/vagrant/assignment1" >> /home/vagrant/.profile

    disp "All done!"

    # Start in /vagrant instead of /home/vagrant
    if ! grep -Fxq "cd /vagrant" /home/vagrant/.bashrc
    then
    echo "cd /vagrant" >> /home/vagrant/.bashrc
    fi
  SHELL

  ## Provisioning to do on each "vagrant up"
  config.vm.provision "shell", run: "always", inline: <<-SHELL
    sudo tzupdate 2> /dev/null
    # Assignment 3
    sudo modprobe tcp_probe port=5001 full=1
  SHELL

  ## CPU & RAM
  config.vm.provider "virtualbox" do |vb|
    vb.customize ["modifyvm", :id, "--cpuexecutioncap", "100"]
    vb.memory = 2048
    vb.cpus = 1
  end

end
